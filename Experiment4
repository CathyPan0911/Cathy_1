/*********************************************************************
 * DF Pong Controller - Pressure Segment Version (Reversed)
 * 
 * Pressure Sensor Version:
 * Weight changes determine paddle movement:
 * - Very light → Strong up
 * - Light → up
 * - Medium → Neutral
 * - Heavy → down
 * - Very heavy → Strong down
 *********************************************************************/

#include <ArduinoBLE.h>
#include "ble_functions.h"
#include "buzzer_functions.h"

// ============================================
// SET YOUR DEVICE NUMBER (1–25)
// ============================================
const int DEVICE_NUMBER = 15;

// Device name
String deviceNameStr = "DFPONG-" + String(DEVICE_NUMBER);
const char* deviceName = deviceNameStr.c_str();

// Pins
const int BUZZER_PIN = 11;
const int LED_PIN = LED_BUILTIN;

int currentMovement = 0;

// ================================
// Pressure sensor
// ================================
const int PRESS_PIN = A0;

// 
int T1 = 200;   // Very light up
int T2 = 230;   // light up
int T3 = 250;   // medium Neutral
int T4 = 260;   // Heavy down
int T5 = 270;   // Very heavy Down


// Setup

void setup() 
{
  Serial.begin(9600);
  delay(1000);

  Serial.println("=== DF Pong Pressure Segment Controller (Reversed) ===");

  pinMode(LED_PIN, OUTPUT);

  setupBLE(deviceName, DEVICE_NUMBER, LED_PIN);
  setupBuzzer(BUZZER_PIN);
}


// Main Loop

void loop() 
{
  updateBLE();
  handleInput();
  sendMovement(currentMovement);
  updateBuzzer(currentMovement);
}


// Pressure → Movement (Reversed)

void handleInput() 
{
  int val = analogRead(PRESS_PIN);
  int movement = 0;

  // pressure(Light UP, Heavy DOWN)
  if (val < T1) {
    movement = 2;   // very light up
  }
  else if (val < T2) {
    movement = 2;   // light up
  }
  else if (val < T3) {
    movement = 0;   // medium Neutral
  }
  else if (val < T4) {
    movement = 1;   // heavy down
  }
  else {
    movement = 1;   // very heavy down
  }

  currentMovement = movement;

  // Debug 
  Serial.print("Pressure = ");
  Serial.print(val);
  Serial.print(" → Movement = ");
  Serial.println(currentMovement);
}
